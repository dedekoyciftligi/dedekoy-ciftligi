<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dedeköy Çiftliği</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{
margin:0;
font-family:'Segoe UI',sans-serif;
background:linear-gradient(135deg,#e8f5e9,#f1f8e9);
}
header{
background:linear-gradient(90deg,#1b5e20,#2e7d32);
color:white;
padding:20px;
text-align:center;
font-size:22px;
font-weight:bold;
}
.container{padding:18px}
.card{
background:white;
margin-bottom:20px;
padding:18px;
border-radius:16px;
box-shadow:0 6px 18px rgba(0,0,0,0.08);
}
button{
padding:12px;
width:100%;
margin-top:8px;
background:#2e7d32;
color:white;
border:none;
border-radius:8px;
font-weight:600;
cursor:pointer;
}
button:hover{background:#1b5e20}
input,select{
width:100%;
padding:10px;
margin-top:6px;
border-radius:6px;
border:1px solid #ccc;
}
.list-item{
padding:10px;
border-bottom:1px solid #eee;
cursor:pointer;
}
.list-item:hover{background:#f1f8e9}
.kesim{color:red;font-weight:bold}
.besi{color:green;font-weight:bold}
.hidden{display:none}
</style>
</head>

<body>

<header>DEDEKÖY ÇİFTLİĞİ YÖNETİM</header>

<div class="container">

<div class="card">
<button onclick="panel('dashboard')">Ana Sayfa</button>
<button onclick="panel('liste')">Hayvan Listesi</button>
<button onclick="panel('ekle')">Hayvan Ekle</button>
<button onclick="panel('arama')">QR / Küpe Ara</button>
<button onclick="panel('kesim')">Kesime Gidecekler</button>
</div>

<div id="dashboard" class="card"></div>

<div id="liste" class="card hidden">
<h3>Hayvan Listesi</h3>
<div id="listeAlan"></div>
</div>

<div id="ekle" class="card hidden">
<h3>Yeni Hayvan</h3>
<input id="yeniQr" placeholder="QR / Küpe No">
<select id="yeniTur">
<option value="DANA">DANA</option>
<option value="INEK">İNEK</option>
<option value="KUZU">KUZU</option>
<option value="KOC">KOÇ</option>
</select>
<input id="yeniKilo" placeholder="İlk Kilo">
<button onclick="hayvanEkle()">Kaydet</button>
</div>

<div id="arama" class="card hidden">
<h3>QR veya Küpe No Ara</h3>
<div id="reader"></div>
<button onclick="kameraBaslat()">QR Başlat</button>
<button onclick="kameraKapat()">QR Kapat</button>
<input id="aramaInput" placeholder="Küpe No / QR">
<button onclick="hayvanGetir()">Ara</button>
</div>

<div id="kesim" class="card hidden">
<h3>⚠ Kesime Gidecekler</h3>
<div id="kesimListe"></div>
</div>

<div id="kart" class="card hidden"></div>

</div>

<script>

const API_URL="https://script.google.com/macros/s/AKfycbwUhg_knEiRUulKxjzbdVRQXX6qFa9ypzhkUDCV8miaoOnggHvr4ADLMeTvSR6H0XA_/exec";
let tumListe=[];
let seciliQr="";
let html5QrCode;

/* PANEL */
function panel(id){
["dashboard","liste","ekle","arama","kesim"]
.forEach(p=>document.getElementById(p).classList.add("hidden"));

document.getElementById(id).classList.remove("hidden");

if(id=="dashboard") dashboard();
if(id=="liste") listeYukle();
if(id=="kesim") kesimYukle();
}

/* DASHBOARD */
async function dashboard(){
const r=await fetch(API_URL,{method:"POST",body:JSON.stringify({tip:"dashboard"})});
const d=await r.json();

let html=`<h3>Genel Durum</h3>
Toplam Hayvan: <b>${d.toplam}</b><br><br>`;

for(let tur in d.turler){
html+=`${tur}: <b>${d.turler[tur]}</b><br>`;
}
document.getElementById("dashboard").innerHTML=html;
}

/* LİSTE */
async function listeYukle(){
const r=await fetch(API_URL,{method:"POST",body:JSON.stringify({tip:"tumHayvanlar"})});
tumListe=await r.json();

let html="";
tumListe.forEach(h=>{
html+=`
<div class="list-item" onclick="kartAc('${h.qr}')">
${h.qr} - ${h.tur}<br>
İlk: ${h.oncekiKilo||"-"} | Son: ${h.sonKilo||"-"}<br>
<span class="${h.durum=='KESIM'?'kesim':'besi'}">${h.durum}</span>
</div>`;
});
document.getElementById("listeAlan").innerHTML=html;
}

/* HAYVAN EKLE */
async function hayvanEkle(){
let qr=document.getElementById("yeniQr").value;
let tur=document.getElementById("yeniTur").value;
let kilo=document.getElementById("yeniKilo").value;

await fetch(API_URL,{method:"POST",
body:JSON.stringify({tip:"hayvanEkle",qr:qr,tur:tur,kilo:kilo})
});

alert("Kaydedildi");
panel("liste");
}

/* HAYVAN GETİR */
async function hayvanGetir(){
let qr=document.getElementById("aramaInput").value;
kartAc(qr);
}

async function kartAc(qr){
const r=await fetch(API_URL,{method:"POST",body:JSON.stringify({tip:"hayvanGetir",qr:qr})});
const d=await r.json();
if(!d){alert("Bulunamadı");return;}

seciliQr=qr;

document.getElementById("kart").classList.remove("hidden");
document.getElementById("kart").innerHTML=`
<h3>Hayvan Kartı</h3>
QR: ${d.qr}<br>
Tür: ${d.tur}<br>
İlk Kilo: ${d.oncekiKilo}<br>
Son Kilo: ${d.sonKilo}<br>
Durum: ${d.durum}
<hr>
<input id="guncelKilo" placeholder="Yeni Kilo">
<button onclick="kiloGuncelle()">Kilo Güncelle</button>
`;
}

/* KİLO GÜNCELLE */
async function kiloGuncelle(){
let kilo=document.getElementById("guncelKilo").value;
await fetch(API_URL,{method:"POST",
body:JSON.stringify({tip:"kiloGuncelle",qr:seciliQr,kilo:kilo})
});
alert("Güncellendi");
panel("liste");
}

/* KESİM */
async function kesimYukle(){
const r=await fetch(API_URL,{method:"POST",body:JSON.stringify({tip:"tumHayvanlar"})});
const d=await r.json();

let html="";
d.filter(x=>x.durum=="KESIM").forEach(x=>{
html+=`<div class="list-item kesim">${x.qr} - ${x.tur}</div>`;
});
document.getElementById("kesimListe").innerHTML=html;
}

/* QR */
function kameraBaslat(){
html5QrCode=new Html5Qrcode("reader");
html5QrCode.start({facingMode:"environment"},{fps:10,qrbox:250},
qr=>{
document.getElementById("aramaInput").value=qr;
html5QrCode.stop();
kartAc(qr);
});
}
function kameraKapat(){
if(html5QrCode) html5QrCode.stop();
}

panel("dashboard");

</script>
</body>
</html>
