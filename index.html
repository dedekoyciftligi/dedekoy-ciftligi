<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dedeköy Çiftliği</title>

<link rel="manifest" href="manifest.json">
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{
  margin:0;
  font-family: 'Segoe UI', sans-serif;
  background:#f4f6f9;
}

header{
  background:linear-gradient(135deg,#1b5e20,#2e7d32);
  color:white;
  padding:20px;
  font-size:20px;
  text-align:center;
  font-weight:bold;
}

.container{
  padding:15px;
  padding-bottom:90px;
}

.card{
  background:white;
  border-radius:15px;
  padding:15px;
  margin-bottom:15px;
  box-shadow:0 5px 15px rgba(0,0,0,0.08);
}

button{
  background:#2e7d32;
  color:white;
  border:none;
  padding:12px;
  width:100%;
  border-radius:10px;
  margin-top:10px;
  font-size:15px;
}

input,select{
  width:100%;
  padding:10px;
  margin-top:8px;
  border-radius:8px;
  border:1px solid #ddd;
}

.bottom-nav{
  position:fixed;
  bottom:0;
  width:100%;
  background:white;
  display:flex;
  justify-content:space-around;
  padding:10px 0;
  box-shadow:0 -2px 10px rgba(0,0,0,0.1);
}

.nav-btn{
  text-align:center;
  font-size:13px;
  color:#2e7d32;
}

.kesim{color:red;font-weight:bold}
.besi{color:green;font-weight:bold}
</style>
</head>

<body>

<header>DEDEKÖY ÇİFTLİĞİ</header>

<div class="container" id="content">

<div class="card">
<h3>Genel Durum</h3>
<div id="toplam"></div>
</div>

</div>

<div class="bottom-nav">
  <div class="nav-btn" onclick="dashboard()">Ana</div>
  <div class="nav-btn" onclick="listele()">Liste</div>
  <div class="nav-btn" onclick="hayvanEkleEkran()">+ Ekle</div>
  <div class="nav-btn" onclick="qrAc()">QR</div>
</div>

<script>
  function hayvanEkleEkran(){
  document.getElementById("content").innerHTML=`
  <div class="card">
    <h3>Yeni Hayvan Ekle</h3>
    <input id="qr" placeholder="QR Kodu (DK-0001)">
    <input id="kupe" placeholder="Küpe No">
    <select id="tur">
      <option value="Koyun">Koyun</option>
      <option value="Kuzu">Kuzu</option>
      <option value="Koç">Koç</option>
      <option value="Düve">Düve</option>
      <option value="Dana">Dana</option>
      <option value="İnek">İnek</option>
      <option value="Boğa">Boğa</option>
    </select>
    <button onclick="hayvanEkle()">Kaydet</button>
  </div>`;
}

async function hayvanEkle(){
  const qr = document.getElementById("qr").value;
  const kupe = document.getElementById("kupe").value;
  const tur = document.getElementById("tur").value;

  await fetch(API_URL,{
    method:"POST",
    body: JSON.stringify({
      tip:"hayvanEkle",
      qr:qr,
      kupe:kupe,
      tur:tur
    })
  });

  alert("Hayvan eklendi");
  dashboard();
}

const API_URL = "https://script.google.com/macros/s/AKfycbwUhg_knEiRUulKxjzbdVRQXX6qFa9ypzhkUDCV8miaoOnggHvr4ADLMeTvSR6H0XA_/exec";

async function dashboard(){
  document.getElementById("content").innerHTML=`
  <div class="card">
  <h3>Genel Durum</h3>
  <div id="toplam"></div>
  </div>`;
  listeVerisi();
}

async function listeVerisi(){
  const response = await fetch(API_URL,{
    method:"POST",
    body: JSON.stringify({tip:"tumHayvanlar"})
  });
  const data = await response.json();
  document.getElementById("toplam").innerHTML=
  "Toplam Hayvan: "+data.length;
}

async function listele(){
  const response = await fetch(API_URL,{
    method:"POST",
    body: JSON.stringify({tip:"tumHayvanlar"})
  });
  const data = await response.json();

  let html="";
  data.forEach(h=>{
    html+=`
    <div class="card">
      <b>${h.kupe}</b><br>
      Tür: ${h.tur}<br>
      Kilo: ${h.sonKilo || "-"}<br>
      Durum: <span class="${h.durum=='KESIM'?'kesim':'besi'}">${h.durum}</span>
    </div>`;
  });

  document.getElementById("content").innerHTML=html;
}

function qrAc(){
  document.getElementById("content").innerHTML=`
  <div class="card">
    <div id="reader"></div>
  </div>`;

  const qr = new Html5Qrcode("reader");
  qr.start({facingMode:"environment"},
  {fps:10,qrbox:250},
  qrCodeMessage=>{
    hayvanGetir(qrCodeMessage);
    qr.stop();
  });
}

async function hayvanGetir(qr){
  const response = await fetch(API_URL,{
    method:"POST",
    body: JSON.stringify({tip:"hayvanGetir",qr:qr})
  });
  const data = await response.json();

  document.getElementById("content").innerHTML=`
  <div class="card">
    <h3>Hayvan Kartı</h3>
    Küpe: ${data.kupe}<br>
    Tür: ${data.tur}<br>
    Son Kilo: ${data.sonKilo || "-"}<br>
    Durum: <span class="${data.durum=='KESIM'?'kesim':'besi'}">${data.durum}</span>
  </div>`;
}

dashboard();

</script>

</body>
</html>
