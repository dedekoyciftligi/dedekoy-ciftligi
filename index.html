<script src="https://unpkg.com/html5-qrcode"></script>

<div style="padding:20px;font-family:Arial">

<h2>Hayvan Yönetim</h2>

<button onclick="kameraAc()">QR Kamera Aç</button>
<button onclick="kameraKapat()">QR Kapat</button>

<div id="reader" style="width:300px;margin-top:10px"></div>

<hr>

<h3>Hayvan Listesi</h3>
<div id="liste"></div>

<hr>

<div id="detay" style="display:none;border:1px solid #ccc;padding:15px;margin-top:10px"></div>

</div>

<script>

const API = "https://script.google.com/macros/s/AKfycbx5NQWC4SCFUKH7iEkG6LYmYZ7kGjN6oV8hUynzuU1PNAO8lUQ-o8zz0zO_6ZEUU6VR/exec";
let scanner;

async function listeYukle(){

const r = await fetch(API,{
method:"POST",
body:JSON.stringify({tip:"liste"})
});

const data = await r.json();

let html="";

data.forEach(h=>{

html+=`
<div onclick="detayGoster('${h.KupeNo}')"
style="padding:10px;border-bottom:1px solid #ddd;cursor:pointer">

<b>${h.Tur}</b> - ${h.KupeNo}  
<br>
İlk: ${h.IlkKilo} kg | Son: ${h.SonKilo} kg  
<br>
Fark: ${h.KiloFark} kg  
<br>
Durum: ${h.Durum}

</div>
`;
});

document.getElementById("liste").innerHTML=html;
}

async function detayGoster(kupe){

const r = await fetch(API,{
method:"POST",
body:JSON.stringify({tip:"liste"})
});

const data = await r.json();
const h = data.find(x=>x.KupeNo==kupe);

document.getElementById("detay").style.display="block";

document.getElementById("detay").innerHTML=`

<h3>${h.Tur} - ${h.KupeNo}</h3>

Kilo Güncelle:
<input id="yeniKilo" type="number">
<button onclick="kiloGuncelle('${h.KupeNo}')">Kaydet</button>

<br><br>

Aşı Güncelle:
<input id="sonAsi" type="date">
<input id="sonrakiAsi" type="date">
<button onclick="asiGuncelle('${h.KupeNo}')">Kaydet</button>

<br><br>

<button onclick="kesimeGonder('${h.KupeNo}')">KESİME GÖNDER</button>

`;
}

async function kiloGuncelle(kupe){

const kilo=document.getElementById("yeniKilo").value;

await fetch(API,{
method:"POST",
body:JSON.stringify({tip:"kiloGuncelle",kupe:kupe,kilo:kilo})
});

alert("Güncellendi");
listeYukle();
}

async function kesimeGonder(kupe){

await fetch(API,{
method:"POST",
body:JSON.stringify({tip:"kesimeGonder",kupe:kupe})
});

alert("Kesime gönderildi");
listeYukle();
}

async function asiGuncelle(kupe){

const sonAsi=document.getElementById("sonAsi").value;
const sonrakiAsi=document.getElementById("sonrakiAsi").value;

await fetch(API,{
method:"POST",
body:JSON.stringify({tip:"asiGuncelle",kupe:kupe,sonAsi:sonAsi,sonrakiAsi:sonrakiAsi})
});

alert("Aşı güncellendi");
}

function kameraAc(){

scanner = new Html5Qrcode("reader");

scanner.start(
{ facingMode: "environment" },
{ fps: 10, qrbox: 250 },
qrCodeMessage => {
alert("QR: "+qrCodeMessage);
scanner.stop();
}
);
}

function kameraKapat(){
if(scanner){
scanner.stop();
}
}

listeYukle();

</script>
