<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{
margin:0;
font-family:Segoe UI;
background:#f3f5f7;
}

header{
background:#1e3a34;
color:white;
padding:18px;
font-size:22px;
font-weight:600;
}

.container{padding:20px;}

.top-cards{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
gap:15px;
margin-bottom:20px;
}

.card{
background:white;
padding:18px;
border-radius:14px;
box-shadow:0 4px 12px rgba(0,0,0,0.08);
}

.card h3{margin:0;font-size:16px;color:#555;}
.card h1{margin:5px 0 0;font-size:28px;}

.section{
background:white;
padding:15px;
border-radius:14px;
box-shadow:0 4px 12px rgba(0,0,0,0.08);
margin-bottom:20px;
}

.list-item{
padding:12px;
border-bottom:1px solid #eee;
cursor:pointer;
}

.list-item:hover{
background:#f9f9f9;
}

.badge{
padding:4px 10px;
border-radius:20px;
font-size:12px;
color:white;
}

.aktif{background:#2e7d32;}
.kesim{background:#c62828;}

button{
padding:10px 15px;
border:none;
border-radius:8px;
background:#1e3a34;
color:white;
cursor:pointer;
margin-right:6px;
}

button:hover{opacity:0.9;}

#modal{
position:fixed;
top:0;left:0;
width:100%;height:100%;
background:rgba(0,0,0,0.5);
display:none;
justify-content:center;
align-items:center;
}

.modal-box{
background:white;
padding:20px;
width:350px;
border-radius:12px;
}

</style>

<header>DEDEKÃ–Y Ã‡Ä°FTLÄ°ÄÄ°</header>

<div class="container">

<div style="margin-bottom:15px;">
<button onclick="listeYukle()">ğŸ”„ Yenile</button>
<button onclick="kameraAc()">ğŸ“· QR Oku</button>
<button onclick="kameraKapat()">âŒ QR Kapat</button>
</div>

<div class="top-cards">
<div class="card">
<h3>Toplam Hayvan</h3>
<h1 id="toplam">0</h1>
</div>

<div class="card">
<h3>Kesime Giden</h3>
<h1 id="kesimSayisi">0</h1>
</div>
</div>

<div id="turKartlari" class="top-cards"></div>

<div class="section">
<h3>Hayvan Listesi</h3>
<div id="liste"></div>
</div>

<div class="section" id="reader" style="display:none;"></div>

</div>

<div id="modal">
<div class="modal-box" id="modalIcerik"></div>
</div>

<script>

const API="https://script.google.com/macros/s/AKfycbx5NQWC4SCFUKH7iEkG6LYmYZ7kGjN6oV8hUynzuU1PNAO8lUQ-o8zz0zO_6ZEUU6VR/exec";

let scanner;

async function listeYukle(){

const r=await fetch(API,{
method:"POST",
body:JSON.stringify({tip:"liste"})
});

const data=await r.json();

let toplam=data.length;
let kesim=0;
let turler={};

let html="";

data.forEach(h=>{

if(h.Durum=="KESIM") kesim++;

if(!turler[h.Tur]) turler[h.Tur]=0;
turler[h.Tur]++;

html+=`
<div class="list-item" onclick="detay('${h.KupeNo}')">
<b>${h.Tur}</b> - ${h.KupeNo}
<br>
Ä°lk: ${h.IlkKilo} kg | Son: ${h.SonKilo} kg
<br>
Fark: ${h.KiloFark} kg
<br>
<span class="badge ${h.Durum=='KESIM'?'kesim':'aktif'}">${h.Durum}</span>
</div>
`;
});

document.getElementById("liste").innerHTML=html;
document.getElementById("toplam").innerText=toplam;
document.getElementById("kesimSayisi").innerText=kesim;

let turHtml="";
for(let t in turler){
turHtml+=`
<div class="card">
<h3>${t}</h3>
<h1>${turler[t]}</h1>
</div>
`;
}

document.getElementById("turKartlari").innerHTML=turHtml;
}

function detay(kupe){

document.getElementById("modal").style.display="flex";

document.getElementById("modalIcerik").innerHTML=`
<h3>Hayvan: ${kupe}</h3>

Yeni Kilo:
<input id="yeniKilo" type="number"><br><br>
<button onclick="kiloGuncelle('${kupe}')">Kilo GÃ¼ncelle</button>

<br><br>

Son AÅŸÄ±:
<input id="sonAsi" type="date"><br>
Sonraki AÅŸÄ±:
<input id="sonrakiAsi" type="date"><br><br>
<button onclick="asiGuncelle('${kupe}')">AÅŸÄ± GÃ¼ncelle</button>

<br><br>

<button style="background:#c62828" onclick="kesime('${kupe}')">KESÄ°ME GÃ–NDER</button>
<br><br>
<button onclick="modalKapat()">Kapat</button>
`;
}

function modalKapat(){
document.getElementById("modal").style.display="none";
}

async function kiloGuncelle(kupe){

const kilo=document.getElementById("yeniKilo").value;

await fetch(API,{
method:"POST",
body:JSON.stringify({tip:"kiloGuncelle",kupe:kupe,kilo:kilo})
});

listeYukle();
modalKapat();
}

async function kesime(kupe){

await fetch(API,{
method:"POST",
body:JSON.stringify({tip:"kesimeGonder",kupe:kupe})
});

listeYukle();
modalKapat();
}

async function asiGuncelle(kupe){

await fetch(API,{
method:"POST",
body:JSON.stringify({
tip:"asiGuncelle",
kupe:kupe,
sonAsi:document.getElementById("sonAsi").value,
sonrakiAsi:document.getElementById("sonrakiAsi").value
})
});

modalKapat();
}

function kameraAc(){
document.getElementById("reader").style.display="block";
scanner=new Html5Qrcode("reader");
scanner.start(
{facingMode:"environment"},
{fps:10,qrbox:250},
msg=>{
alert("QR: "+msg);
scanner.stop();
});
}

function kameraKapat(){
if(scanner){
scanner.stop();
document.getElementById("reader").style.display="none";
}
}

listeYukle();

</script>
