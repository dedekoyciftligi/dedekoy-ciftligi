<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dedeköy Çiftliği</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
*{box-sizing:border-box}
body{
  font-family:Arial;
  margin:0;
  background:#f2f2f2;
}
header{
  background:#1b5e20;
  color:white;
  padding:15px;
  text-align:center;
  font-size:20px;
}
.card{
  background:white;
  margin:10px;
  padding:15px;
  border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
}
button{
  padding:14px;
  width:100%;
  margin-top:10px;
  background:#2e7d32;
  color:white;
  border:none;
  border-radius:8px;
  font-size:16px;
}
.stop{background:#c62828}
input{
  width:100%;
  padding:12px;
  margin-top:8px;
  font-size:16px;
}
#reader{
  width:100%;
  margin-top:10px;
}
.kesim{color:red;font-weight:bold}
.besi{color:green;font-weight:bold}
</style>
</head>

<body>

<header>DEDEKÖY ÇİFTLİĞİ</header>

<div class="card">
<h3>QR İşlemleri</h3>
<button onclick="startQR()">QR Kamerayı Aç</button>
<button onclick="stopQR()" class="stop">Kamerayı Kapat</button>
<div id="reader"></div>
</div>

<div class="card">
<h3>Manuel Küpe / QR Ara</h3>
<input type="text" id="arama" placeholder="QR veya Küpe No">
<button onclick="hayvanGetir()">Hayvanı Getir</button>
</div>

<div id="hayvanKart"></div>

<script>

const API_URL = "https://script.google.com/macros/s/AKfycbwjE_8OBm_LmAGEgjl8S6uiyW4kknlW7N5X84Pt95D7WK-IF8Yelqn-UA73-qK0eFXI/exec";

let html5QrCode;
let kameraAcik = false;

function startQR(){
  if(kameraAcik) return;

  html5QrCode = new Html5Qrcode("reader");

  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    qrMessage => {
      document.getElementById("arama").value = qrMessage;
      stopQR();
      hayvanGetir();
    }
  );

  kameraAcik = true;
}

function stopQR(){
  if(!kameraAcik) return;

  html5QrCode.stop().then(() => {
    html5QrCode.clear();
    document.getElementById("reader").innerHTML="";
    kameraAcik = false;
  }).catch(()=>{});
}

async function hayvanGetir(){
  const arama = document.getElementById("arama").value;

  const response = await fetch(API_URL,{
    method:"POST",
    body: JSON.stringify({
      tip:"hayvanGetir",
      qr: arama
    })
  });

  const data = await response.json();

  if(!data){
    alert("Hayvan bulunamadı");
    return;
  }

  document.getElementById("hayvanKart").innerHTML = `
  <div class="card">
  <h3>Hayvan Kartı</h3>
  QR: ${data.qr}<br>
  Küpe: ${data.kupe}<br>
  Tür: ${data.tur}<br>
  Son Kilo: ${data.sonKilo}<br>
  Durum: <span class="${data.durum == 'KESIM' ? 'kesim':'besi'}">${data.durum}</span>
  </div>
  `;
}

</script>

</body>
</html>
