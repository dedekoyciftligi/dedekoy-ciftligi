<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dedeköy Çiftliği</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{margin:0;font-family:Arial;background:#f4f6f5}
header{background:#1b5e20;color:white;padding:18px;text-align:center;font-size:20px;font-weight:bold}
.container{padding:15px}
.card{background:white;margin-bottom:15px;padding:15px;border-radius:14px;box-shadow:0 4px 10px rgba(0,0,0,0.08)}
button{padding:12px;width:100%;margin-top:8px;background:#2e7d32;color:white;border:none;border-radius:8px}
input{width:100%;padding:10px;margin-top:6px;border-radius:6px;border:1px solid #ccc}
.list-item{padding:10px;border-bottom:1px solid #eee;cursor:pointer}
.list-item:hover{background:#f0f0f0}
.kesim{color:red;font-weight:bold}
.besi{color:green;font-weight:bold}
.hidden{display:none}
.kiloBox{font-size:13px;margin-top:4px;color:#555}
.menu button{margin-bottom:6px}
</style>
</head>

<body>

<header>DEDEKÖY ÇİFTLİĞİ</header>

<div class="container">

<div class="card menu">
<button onclick="panelGoster('dashboard')">Ana Sayfa</button>
<button onclick="panelGoster('liste')">Hayvan Listesi</button>
<button onclick="panelGoster('arama')">Hayvan Ara</button>
</div>

<div id="dashboardPanel" class="card">
<h3>Genel Durum</h3>
<div><b>Toplam Hayvan:</b> <span id="toplam">0</span></div>
<div id="turSayilari" style="margin-top:10px;"></div>
</div>

<div id="listePanel" class="card hidden">
<h3>Hayvan Listesi</h3>
<input id="listeArama" placeholder="Ara..." onkeyup="listeFiltre()">
<div id="liste"></div>
</div>

<div id="aramaPanel" class="card hidden">
<h3>Hayvan Ara</h3>
<input id="arama" placeholder="QR">
<button onclick="hayvanGetir()">Ara</button>
</div>

<div id="kartPanel" class="card hidden"></div>

</div>

<script>

const API_URL="https://script.google.com/macros/s/AKfycbwUhg_knEiRUulKxjzbdVRQXX6qFa9ypzhkUDCV8miaoOnggHvr4ADLMeTvSR6H0XA_/exec";

let tumListe=[];

/* PANEL */
function panelGoster(panel){
document.getElementById("dashboardPanel").classList.add("hidden");
document.getElementById("listePanel").classList.add("hidden");
document.getElementById("aramaPanel").classList.add("hidden");

if(panel=="dashboard")
document.getElementById("dashboardPanel").classList.remove("hidden");

if(panel=="liste")
document.getElementById("listePanel").classList.remove("hidden");

if(panel=="arama")
document.getElementById("aramaPanel").classList.remove("hidden");
}

/* DASHBOARD */
async function dashboardYukle(){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({tip:"dashboard"})});
const data=await res.json();

document.getElementById("toplam").innerText=data.toplam;

let turHtml="";
for(let tur in data.turler){
if(data.turler[tur] > 0){
turHtml+=`<div><b>${tur}:</b> ${data.turler[tur]}</div>`;
}
}
document.getElementById("turSayilari").innerHTML=turHtml;
}

/* LİSTE */
async function listeYukle(){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({tip:"tumHayvanlar"})});
tumListe=await res.json();
listeRender(tumListe);
}

function listeRender(data){
let html="";
data.forEach(h=>{
html+=`
<div class="list-item">
<b>${h.qr}</b> - ${h.tur}
<div class="kiloBox">
Önceki: ${h.oncekiKilo || "-"} kg |
Mevcut: ${h.sonKilo || "-"} kg
</div>
<div class="${h.durum=='KESIM'?'kesim':'besi'}">${h.durum}</div>
</div>
`;
});
document.getElementById("liste").innerHTML=html;
}

function listeFiltre(){
let q=document.getElementById("listeArama").value.toLowerCase();
let filtre=tumListe.filter(h=>h.qr.toLowerCase().includes(q));
listeRender(filtre);
}

/* HAYVAN GETİR */
async function hayvanGetir(){
const qr=document.getElementById("arama").value;
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({tip:"hayvanGetir",qr:qr})});
const data=await res.json();

if(!data){alert("Bulunamadı");return;}

document.getElementById("kartPanel").classList.remove("hidden");
document.getElementById("kartPanel").innerHTML=`
<h3>Hayvan Kartı</h3>
<b>QR:</b> ${data.qr}<br>
<b>Tür:</b> ${data.tur}<br>
<b>Önceki Kilo:</b> ${data.oncekiKilo || "-"} kg<br>
<b>Mevcut Kilo:</b> ${data.sonKilo || "-"} kg<br>
<b>Durum:</b> ${data.durum}
`;
}

dashboardYukle();
listeYukle();
panelGoster("dashboard");

</script>
</body>
</html>
