<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dedeköy Çiftliği</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{
margin:0;
font-family:'Segoe UI',sans-serif;
background:linear-gradient(135deg,#e8f5e9,#f1f8e9);
}
header{
background:linear-gradient(90deg,#1b5e20,#2e7d32);
color:white;
padding:22px;
text-align:center;
font-size:22px;
letter-spacing:1px;
box-shadow:0 4px 12px rgba(0,0,0,0.2);
}
.container{padding:18px}
.card{
background:white;
margin-bottom:20px;
padding:18px;
border-radius:18px;
box-shadow:0 8px 20px rgba(0,0,0,0.08);
}
button{
padding:12px;
width:100%;
margin-top:8px;
background:#2e7d32;
color:white;
border:none;
border-radius:10px;
font-weight:600;
cursor:pointer;
}
button:hover{background:#1b5e20}
input{
width:100%;
padding:10px;
margin-top:6px;
border-radius:8px;
border:1px solid #ccc;
}
.list-item{
padding:12px;
border-bottom:1px solid #eee;
}
.kesim{color:red;font-weight:bold}
.besi{color:green;font-weight:bold}
.hidden{display:none}
#reader{margin-top:10px}
</style>
</head>

<body>

<header>DEDEKÖY ÇİFTLİĞİ YÖNETİM PANELİ</header>

<div class="container">

<div class="card">
<button onclick="panelGoster('dashboard')">Ana Sayfa</button>
<button onclick="panelGoster('liste')">Hayvan Listesi</button>
<button onclick="panelGoster('arama')">QR ile Ara</button>
<button onclick="panelGoster('kesim')">Kesime Gidecekler</button>
</div>

<div id="dashboardPanel" class="card"></div>

<div id="listePanel" class="card hidden">
<h3>Hayvan Listesi</h3>
<input id="listeArama" placeholder="Ara..." onkeyup="listeFiltre()">
<div id="liste"></div>
</div>

<div id="aramaPanel" class="card hidden">
<h3>QR Okut</h3>
<div id="reader"></div>
<button onclick="kameraBaslat()">QR Başlat</button>
<button onclick="kameraKapat()">QR Kapat</button>
<input id="arama" placeholder="QR Manuel">
<button onclick="hayvanGetir()">Ara</button>
</div>

<div id="kesimPanel" class="card hidden">
<h3>⚠ Kesime Gidecekler</h3>
<div id="kesimListe"></div>
</div>

<div id="kartPanel" class="card hidden"></div>

</div>

<script>

const API_URL="https://script.google.com/macros/s/AKfycbwUhg_knEiRUulKxjzbdVRQXX6qFa9ypzhkUDCV8miaoOnggHvr4ADLMeTvSR6H0XA_/exec";
let tumListe=[];
let html5QrCode;

/* PANEL */
function panelGoster(p){
["dashboardPanel","listePanel","aramaPanel","kesimPanel"]
.forEach(id=>document.getElementById(id).classList.add("hidden"));

if(p=="dashboard") dashboardYukle();
if(p=="liste") listeYukle();
if(p=="kesim") kesimListeYukle();

document.getElementById(p+"Panel").classList.remove("hidden");
}

/* DASHBOARD */
async function dashboardYukle(){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({tip:"dashboard"})});
const data=await res.json();

let turHtml="";
for(let tur in data.turler){
turHtml+=`<div><b>${tur}:</b> ${data.turler[tur]}</div>`;
}

document.getElementById("dashboardPanel").innerHTML=`
<h3>Genel Durum</h3>
<div><b>Toplam Hayvan:</b> ${data.toplam}</div>
${turHtml}
`;
}

/* LİSTE */
async function listeYukle(){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({tip:"tumHayvanlar"})});
tumListe=await res.json();
listeRender(tumListe);
}

function listeRender(data){
let html="";
data.forEach(h=>{
html+=`
<div class="list-item">
<b>${h.qr}</b> - ${h.tur}<br>
İlk: ${h.oncekiKilo || "-"} kg |
Son: ${h.sonKilo || "-"} kg<br>
<div class="${h.durum=='KESIM'?'kesim':'besi'}">${h.durum}</div>
</div>`;
});
document.getElementById("liste").innerHTML=html;
}

function listeFiltre(){
let q=document.getElementById("listeArama").value.toLowerCase();
listeRender(tumListe.filter(h=>h.qr.toLowerCase().includes(q)));
}

/* KESİM LİSTE */
async function kesimListeYukle(){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({tip:"tumHayvanlar"})});
const data=await res.json();

let html="";
data.filter(h=>h.durum=="KESIM").forEach(h=>{
html+=`<div class="list-item kesim"><b>${h.qr}</b> - ${h.tur}</div>`;
});
document.getElementById("kesimListe").innerHTML=html;
}

/* HAYVAN GETİR */
async function hayvanGetir(){
const qr=document.getElementById("arama").value;
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({tip:"hayvanGetir",qr:qr})});
const data=await res.json();
if(!data){alert("Bulunamadı");return;}

document.getElementById("kartPanel").classList.remove("hidden");
document.getElementById("kartPanel").innerHTML=`
<h3>Hayvan Kartı</h3>
QR: ${data.qr}<br>
Tür: ${data.tur}<br>
İlk Kilo: ${data.oncekiKilo || "-"} kg<br>
Son Kilo: ${data.sonKilo || "-"} kg<br>
Durum: ${data.durum}
`;
}

/* QR */
function kameraBaslat(){
html5QrCode=new Html5Qrcode("reader");
html5QrCode.start({facingMode:"environment"},{fps:10,qrbox:250},
qr=>{
document.getElementById("arama").value=qr;
html5QrCode.stop();
hayvanGetir();
});
}
function kameraKapat(){
if(html5QrCode) html5QrCode.stop();
}

panelGoster("dashboard");

</script>
</body>
</html>
